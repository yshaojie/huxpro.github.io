---
layout:     post
title:      "k8s生产集群部署"
date:       2020-05-13 17:03:00
author:     "聼雨夜"
catalog: true
tags:
    - docker
    - k8s
---
#### 环境初始化

##### 软件版本
```bash
k8s_version=1.18.2
docker_version=19.03.8
calico_version=3.13
```
##### 添加网桥过滤
```bash
# 添加网桥过滤及地址转发
cat > /etc/sysctl.d/k8s.conf << EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
vm.swappiness = 0

EOF

# 加载 br_netfilter 模块
modprobe br_netfilter
# 查看是否加载
lsmod | grep br_netfilter

# 加载网桥过滤配置文件
sysctl -p /etc/sysctl.d/k8s.conf
#关闭swap
swapoff -a && sed -i '/ swap / s/^/#/' /etc/fstab
systemctl disable firewalld && systemctl stop firewalld

```
##### 开启 IPVS
```bash
#安装 ipset 及 ipvsadm
yum install -y ipset ipvsadm

# 添加需要加载的模块
cat > /etc/sysconfig/modules/ipvs.modules << EOF
#!/bin/bash
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack_ipv4
EOF

# 授权、运行、检查是否加载
chmod +x /etc/sysconfig/modules/ipvs.modules && bash /etc/sysconfig/modules/ipvs.modules && lsmod | grep -e ip_vs -e nf_conntrack_ipv4
```

#### 初始化docker

##### 安装docker
```bash
#安装依赖
yum install -y yum-utils device-mapper-persistent-data lvm2

#重置 docker repo 文件
rm -f /etc/yum.repos.d/docker-ce.repo
wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -P /etc/yum.repos.d/

#安装指定版本
yum install docker-ce-${docker_version} docker-ce-cli-${docker_version} containerd.io
```

##### 初始化并启动docker
```bash
#初始化配置
cat > /etc/docker/daemon.json << EOF
{
  "registry-mirrors": ["https://registry.docker-cn.com","https://registry.aliyuncs.com"],
  "insecure-registries":["私有仓库"],
  "max-concurrent-downloads": 10,
  "live-restore": true,
  "log-driver": "local",
  "log-level": "warn",
  "exec-opts": ["native.cgroupdriver=systemd"],
  "log-opts": {
    "max-size": "100m",
    "max-file": "5"
    },
  "data-root": "/data/docker"
}
EOF
#创建所需目录
chmod 655 /data/docker/ 
chmod -R 655 /data/docker/containers/

#开机启动
systemctl enable docker
systemctl start docker
```

#### kubernetes安装并启动

##### k8s rpo设置
```bash
cat > /etc/yum.repos.d/k8s.repo << EOF
[kubernetes]
name=Kubernetes
baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=1
repo_gpgcheck=0
gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
       http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF

# 安装kubeadm kubelet kubectl
yum install -y kubeadm-${k8s_version}-0 kubelet-${k8s_version}-0 kubectl-${k8s_version}-0

#docker配置中的 的 cgroup driver 做了修改，这里 kubelet 需要保持一致，需修改如下配置内容
cat > /etc/sysconfig/kubelet << EOF
KUBELET_EXTRA_ARGS="--cgroup-driver=systemd"
EOF
#解决k8s pull 镜像时的权限问题
sed -i "s/\[Service\]/\[Service\]\\nUser=root/g" /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf
#对 kubelet 设置为开机启动即可
systemctl enable kubelet

```

##### k8s master节点初始化
```bash
kubeadm reset
kubeadm init --image-repository registry.aliyuncs.com/google_containers --kubernetes-version v${k8s_version} --pod-network-cidr=192.168.0.0/16
```
```text
如果看到如下内容表示执行成功
Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:
  #运行以下命令是kubectl可执行
  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

You should now deploy a pod network to the cluster.
Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can join any number of worker nodes by running the following on each as root:
#在work宿主机执行以下命令来加入集群
kubeadm join 192.168.0.114:6443 --token 2xjokn.mxcdy3sv2teg5qtr \
    --discovery-token-ca-cert-hash sha256:e0289d4f18dd7f1530bad0863492546fd36d6a43617d7e8388b289f18b41a357

```

##### k8s work节点初始化
```bash
kubeadm reset
kubeadm join 192.168.0.114:6443 --token 2xjokn.mxcdy3sv2teg5qtr \
    --discovery-token-ca-cert-hash sha256:e0289d4f18dd7f1530bad0863492546fd36d6a43617d7e8388b289f18b41a357
```

#### 其他

##### 删除节点
```bash
kubectl drain ${node_name} --delete-local-data --force --ignore-daemonsets
kubectl delete node  ${node_name}

```
##### 卸载k8s和docker
```bash
yum remove docker-ce
rm -rf /var/lib/docker
yum remove kubeadm kubectl kubelet kubernetes-cni kube*
```
