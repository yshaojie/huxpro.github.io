---
layout:     post
title:      "2020-05-13-k8s生产集群部署"
date:       2020-05-13 17:03:00
author:     "聼雨夜"
catalog: true
tags:
    - docker
    - k8s
---
#### 环境初始化

##### 添加网桥过滤
```bash
# 添加网桥过滤及地址转发
cat > /etc/sysctl.d/k8s.conf << EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
vm.swappiness = 0
EOF

# 加载 br_netfilter 模块
modprobe br_netfilter
# 查看是否加载
lsmod | grep br_netfilter

# 加载网桥过滤配置文件
sysctl -p /etc/sysctl.d/k8s.conf
#关闭swap
swapoff -a
```
##### 开启 IPVS
```bash
#安装 ipset 及 ipvsadm
yum install -y ipset ipvsadm

# 添加需要加载的模块
cat > /etc/sysconfig/modules/ipvs.modules << EOF
#!/bin/bash
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack_ipv4
EOF

# 授权、运行、检查是否加载
chmod +x /etc/sysconfig/modules/ipvs.modules && bash /etc/sysconfig/modules/ipvs.modules && lsmod | grep -e ip_vs -e nf_conntrack_ipv4
```

#### 初始化docker
##### 安装docker
```bash
#安装依赖
yum install -y yum-utils device-mapper-persistent-data lvm2

#重置 docker repo 文件
rm -f /etc/yum.repos.d/docker-ce.repo
wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -P /etc/yum.repos.d/

#安装指定版本
yum install docker-ce-19.03.8 docker-ce-cli-19.03.8 containerd.io
```
##### 初始化并启动docker
```bash
#初始化配置
cat > /etc/docker/daemon.json << EOF
{
  "registry-mirrors": ["https://registry.docker-cn.com","https://registry.aliyuncs.com"],
  "insecure-registries":["私有仓库"],
  "max-concurrent-downloads": 10,
  "live-restore": true,
  "log-driver": "local",
  "log-level": "warn",
  "exec-opts": ["native.cgroupdriver=systemd"],
  "hosts":["tcp://0.0.0.0:2375","fd://"],
  "log-opts": {
    "max-size": "100m",
    "max-file": "5"
    },
  "data-root": "/data/docker"
}
EOF
#创建所需目录
chmod 655 /data/docker/ 
chmod -R 655 /data/docker/containers/

#开机启动
systemctl enable docker
systemctl start docker
```

#### kubernetes安装并启动
##### k8s rpo设置
```bash
cat > /etc/yum.repos.d/k8s.repo << EOF
[kubernetes]
name=Kubernetes
baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=1
repo_gpgcheck=0
gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
       http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF

# 安装kubeadm kubelet kubectl
yum install -y kubeadm-1.18.2-0 kubelet-1.18.2-0 kubectl-1.18.2-0

#docker配置中的 的 cgroup driver 做了修改，这里 kubelet 需要保持一致，需修改如下配置内容
cat > /etc/sysconfig/kubelet << EOF
KUBELET_EXTRA_ARGS="--cgroup-driver=systemd"
EOF
#对 kubelet 设置为开机启动即可
systemctl enable kubelet

```

##### 镜像准备
```bash
images=($(kubeadm config images list | grep "k8s.gcr.io"))
for image in "${images[@]}"
do
    image_name=(${image//\// })
    image_addr="registry.aliyuncs.com/google_containers/${image_name[1]}"
    new_image_addr="k8s.gcr.io/${image_name[1]}"
    docker pull ${image_addr}
    docker image tag  ${image_addr} ${new_image_addr}
    docker rmi ${image_addr}
done
```



##### 提前下载镜像
```bash
docker pull registry.aliyuncs.com/google_containers/kube-apiserver:v1.18.2
docker pull registry.aliyuncs.com/google_containers/kube-controller-manager:v1.18.2
docker pull registry.aliyuncs.com/google_containers/kube-scheduler:v1.18.2
docker pull registry.aliyuncs.com/google_containers/kube-proxy:v1.18.2
docker pull registry.aliyuncs.com/google_containers/pause:3.2
docker pull registry.aliyuncs.com/google_containers/etcd:3.4.3-0
docker pull registry.aliyuncs.com/google_containers/coredns:1.6.7
```